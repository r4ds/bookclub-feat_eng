WARNING: unknown option '-vaniila'


R version 3.6.0 (2019-04-26) -- "Planting of a Tree"
Copyright (C) 2019 The R Foundation for Statistical Computing
Platform: x86_64-apple-darwin15.6.0 (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> # ------------------------------------------------------------------------------
> # Feature Engineering and Selection: A Practical Approach for Predictive Models
> # by Max Kuhn and Kjell Johnson
> #
> # ------------------------------------------------------------------------------
> # 
> # Code for Section 5.4 at
> # https://bookdown.org/max/FES/categorical-supervised-encoding.html
> #
> # ------------------------------------------------------------------------------
> # 
> # Code requires these packages: 
> 
> library(tidymodels)
Registered S3 methods overwritten by 'ggplot2':
  method         from 
  [.quosures     rlang
  c.quosures     rlang
  print.quosures rlang
Registered S3 method overwritten by 'xts':
  method     from
  as.zoo.xts zoo 
── Attaching packages ────────────────────────────────────── tidymodels 0.0.2 ──
✔ broom     0.5.1       ✔ purrr     0.3.1  
✔ dials     0.0.2       ✔ recipes   0.1.5  
✔ dplyr     0.8.0.1     ✔ rsample   0.0.4  
✔ ggplot2   3.1.0       ✔ tibble    2.0.1  
✔ infer     0.4.0       ✔ yardstick 0.0.2  
✔ parsnip   0.0.1       
── Conflicts ───────────────────────────────────────── tidymodels_conflicts() ──
✖ purrr::discard() masks scales::discard()
✖ dplyr::filter()  masks stats::filter()
✖ dplyr::lag()     masks stats::lag()
✖ recipes::step()  masks stats::step()
> library(embed)
> library(plotly)

Attaching package: ‘plotly’

The following object is masked from ‘package:ggplot2’:

    last_plot

The following object is masked from ‘package:stats’:

    filter

The following object is masked from ‘package:graphics’:

    layout

> library(gridExtra)

Attaching package: ‘gridExtra’

The following object is masked from ‘package:dplyr’:

    combine

> 
> options(width = 120)
> 
> # Create example data ----------------------------------------------------------
> 
> load("../Data_Sets/OkCupid/okc.RData")
> load("../Data_Sets/OkCupid/okc_binary.RData")
> 
> # Partial pooling example ------------------------------------------------------
> 
> partial_rec <- 
+   recipe(Class ~ ., data = okc_train) %>%
+   step_lencode_bayes(
+     where_town,
+     outcome = vars(Class),
+     verbose = FALSE,
+     options = list(
+       chains = 5, 
+       iter = 1000, 
+       cores = min(parallel::detectCores(), 5),
+       seed = 18324
+     )
+   ) %>%
+   prep()
> 
> # Get raw rates and log-odds
> okc_props <- 
+   okc_train %>%
+   group_by(where_town) %>%
+   summarise(
+     rate = mean(Class == "stem"),
+     raw  = log(rate/(1-rate)),
+     n = length(Class)
+   ) %>%
+   mutate(where_town = as.character(where_town))
> 
> okc_props
# A tibble: 51 x 4
   where_town          rate   raw     n
   <chr>              <dbl> <dbl> <int>
 1 alameda           0.157  -1.68   616
 2 albany            0.192  -1.44   146
 3 belmont           0.234  -1.19   167
 4 belvedere_tiburon 0.0857 -2.37    35
 5 benicia           0.107  -2.13   122
 6 berkeley          0.163  -1.64  2676
 7 burlingame        0.181  -1.51   248
 8 castro_valley     0.124  -1.95   225
 9 corte_madera      0.111  -2.08    54
10 daly_city         0.134  -1.86   417
# … with 41 more rows
> 
> # Embedding methods ------------------------------------------------------------
> 
> # Get the keyword columns
> keywords <- names(okc_train_binary)[-1]
> 
> # Merge the basic OkC data with the keyword indicators
> okc_embed <-
+   okc_train %>% 
+   dplyr::select(Class, where_town, profile) %>%
+   full_join(okc_train_binary, by = "profile")
> 
> # Tensorflow wants doubles instead of binary integers
> okc_embed[, keywords] <- apply(okc_embed[, keywords], 2, as.numeric)
> 
> # Use the entity embedding for supervised learning
> set.seed(355)
> nnet_rec <- 
+   recipe(Class ~ ., data = okc_embed) %>% 
+   step_embed(
+     where_town,
+     outcome = vars(Class),
+     num_terms = 3,
+     hidden_units = 10,
+     predictors = vars(!!!keywords),
+     options = embed_control(
+       loss = "binary_crossentropy",
+       epochs = 30,
+       validation_split = 0.2,
+       verbose = 1
+     )
+   ) %>%
+   prep()
2019-06-17 07:17:39.155955: I tensorflow/core/platform/cpu_feature_guard.cc:141] Your CPU supports instructions that this TensorFlow binary was not compiled to use: AVX2 FMA
Set session seed to 6116 (disabled GPU, CPU parallelism)
/Users/max/.virtualenvs/r-tensorflow/lib/python2.7/site-packages/tensorflow/python/ops/gradients_impl.py:108: UserWarning: Converting sparse IndexedSlices to a dense Tensor of unknown shape. This may consume a large amount of memory.
  "Converting sparse IndexedSlices to a dense Tensor of unknown shape. "
Train on 31047 samples, validate on 7762 samples
Epoch 1/30
   32/31047 [..............................] - ETA: 3:37 - loss: 0.6588 1376/31047 [>.............................] - ETA: 5s - loss: 0.5831   2720/31047 [=>............................] - ETA: 3s - loss: 0.5481 4096/31047 [==>...........................] - ETA: 2s - loss: 0.5443 5408/31047 [====>.........................] - ETA: 2s - loss: 0.5315 6560/31047 [=====>........................] - ETA: 1s - loss: 0.5201 7616/31047 [======>.......................] - ETA: 1s - loss: 0.5168 8736/31047 [=======>......................] - ETA: 1s - loss: 0.5150 9952/31047 [========>.....................] - ETA: 1s - loss: 0.507611264/31047 [=========>....................] - ETA: 1s - loss: 0.501812544/31047 [===========>..................] - ETA: 1s - loss: 0.501113888/31047 [============>.................] - ETA: 0s - loss: 0.496615232/31047 [=============>................] - ETA: 0s - loss: 0.494116544/31047 [==============>...............] - ETA: 0s - loss: 0.490617792/31047 [================>.............] - ETA: 0s - loss: 0.487019168/31047 [=================>............] - ETA: 0s - loss: 0.486120544/31047 [==================>...........] - ETA: 0s - loss: 0.483721888/31047 [====================>.........] - ETA: 0s - loss: 0.481823200/31047 [=====================>........] - ETA: 0s - loss: 0.479624512/31047 [======================>.......] - ETA: 0s - loss: 0.478125856/31047 [=======================>......] - ETA: 0s - loss: 0.476327072/31047 [=========================>....] - ETA: 0s - loss: 0.475528320/31047 [==========================>...] - ETA: 0s - loss: 0.473529504/31047 [===========================>..] - ETA: 0s - loss: 0.472530752/31047 [============================>.] - ETA: 0s - loss: 0.471231047/31047 [==============================] - 2s 49us/step - loss: 0.4711 - val_loss: 0.4217
Epoch 2/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4066 1376/31047 [>.............................] - ETA: 1s - loss: 0.4316 2752/31047 [=>............................] - ETA: 1s - loss: 0.4352 4096/31047 [==>...........................] - ETA: 1s - loss: 0.4308 5504/31047 [====>.........................] - ETA: 0s - loss: 0.4304 6880/31047 [=====>........................] - ETA: 0s - loss: 0.4312 7904/31047 [======>.......................] - ETA: 0s - loss: 0.4323 9280/31047 [=======>......................] - ETA: 0s - loss: 0.431410688/31047 [=========>....................] - ETA: 0s - loss: 0.429112064/31047 [==========>...................] - ETA: 0s - loss: 0.430313472/31047 [============>.................] - ETA: 0s - loss: 0.429814848/31047 [=============>................] - ETA: 0s - loss: 0.430016256/31047 [==============>...............] - ETA: 0s - loss: 0.430317632/31047 [================>.............] - ETA: 0s - loss: 0.429819040/31047 [=================>............] - ETA: 0s - loss: 0.428820416/31047 [==================>...........] - ETA: 0s - loss: 0.429221792/31047 [====================>.........] - ETA: 0s - loss: 0.429223168/31047 [=====================>........] - ETA: 0s - loss: 0.428624576/31047 [======================>.......] - ETA: 0s - loss: 0.428625920/31047 [========================>.....] - ETA: 0s - loss: 0.427727232/31047 [=========================>....] - ETA: 0s - loss: 0.427228352/31047 [==========================>...] - ETA: 0s - loss: 0.426229536/31047 [===========================>..] - ETA: 0s - loss: 0.425930592/31047 [============================>.] - ETA: 0s - loss: 0.424731047/31047 [==============================] - 1s 40us/step - loss: 0.4241 - val_loss: 0.3973
Epoch 3/30
   32/31047 [..............................] - ETA: 3s - loss: 0.5413 1184/31047 [>.............................] - ETA: 1s - loss: 0.4172 2336/31047 [=>............................] - ETA: 1s - loss: 0.4112 3424/31047 [==>...........................] - ETA: 1s - loss: 0.4101 4608/31047 [===>..........................] - ETA: 1s - loss: 0.4093 5728/31047 [====>.........................] - ETA: 1s - loss: 0.4156 6912/31047 [=====>........................] - ETA: 1s - loss: 0.4147 8096/31047 [======>.......................] - ETA: 1s - loss: 0.4181 9280/31047 [=======>......................] - ETA: 0s - loss: 0.418010464/31047 [=========>....................] - ETA: 0s - loss: 0.417711680/31047 [==========>...................] - ETA: 0s - loss: 0.417512864/31047 [===========>..................] - ETA: 0s - loss: 0.418114080/31047 [============>.................] - ETA: 0s - loss: 0.418615232/31047 [=============>................] - ETA: 0s - loss: 0.416716448/31047 [==============>...............] - ETA: 0s - loss: 0.416017760/31047 [================>.............] - ETA: 0s - loss: 0.415519040/31047 [=================>............] - ETA: 0s - loss: 0.413320128/31047 [==================>...........] - ETA: 0s - loss: 0.412521248/31047 [===================>..........] - ETA: 0s - loss: 0.411722368/31047 [====================>.........] - ETA: 0s - loss: 0.411823552/31047 [=====================>........] - ETA: 0s - loss: 0.412124704/31047 [======================>.......] - ETA: 0s - loss: 0.411025984/31047 [========================>.....] - ETA: 0s - loss: 0.409527264/31047 [=========================>....] - ETA: 0s - loss: 0.409228448/31047 [==========================>...] - ETA: 0s - loss: 0.409029536/31047 [===========================>..] - ETA: 0s - loss: 0.409430656/31047 [============================>.] - ETA: 0s - loss: 0.408931047/31047 [==============================] - 1s 46us/step - loss: 0.4090 - val_loss: 0.3865
Epoch 4/30
   32/31047 [..............................] - ETA: 3s - loss: 0.2874 1152/31047 [>.............................] - ETA: 1s - loss: 0.3963 2336/31047 [=>............................] - ETA: 1s - loss: 0.4034 3520/31047 [==>...........................] - ETA: 1s - loss: 0.4021 4608/31047 [===>..........................] - ETA: 1s - loss: 0.4000 5792/31047 [====>.........................] - ETA: 1s - loss: 0.4003 6944/31047 [=====>........................] - ETA: 1s - loss: 0.4055 8096/31047 [======>.......................] - ETA: 1s - loss: 0.4060 9312/31047 [=======>......................] - ETA: 0s - loss: 0.409110464/31047 [=========>....................] - ETA: 0s - loss: 0.406511648/31047 [==========>...................] - ETA: 0s - loss: 0.405512896/31047 [===========>..................] - ETA: 0s - loss: 0.406514208/31047 [============>.................] - ETA: 0s - loss: 0.404915392/31047 [=============>................] - ETA: 0s - loss: 0.405116512/31047 [==============>...............] - ETA: 0s - loss: 0.405117664/31047 [================>.............] - ETA: 0s - loss: 0.404618752/31047 [=================>............] - ETA: 0s - loss: 0.404519872/31047 [==================>...........] - ETA: 0s - loss: 0.403220960/31047 [===================>..........] - ETA: 0s - loss: 0.403222112/31047 [====================>.........] - ETA: 0s - loss: 0.403623360/31047 [=====================>........] - ETA: 0s - loss: 0.403824736/31047 [======================>.......] - ETA: 0s - loss: 0.404126048/31047 [========================>.....] - ETA: 0s - loss: 0.403827456/31047 [=========================>....] - ETA: 0s - loss: 0.404828736/31047 [==========================>...] - ETA: 0s - loss: 0.404130144/31047 [============================>.] - ETA: 0s - loss: 0.402431047/31047 [==============================] - 1s 44us/step - loss: 0.4014 - val_loss: 0.3804
Epoch 5/30
   32/31047 [..............................] - ETA: 2s - loss: 0.2889 1184/31047 [>.............................] - ETA: 1s - loss: 0.3532 2336/31047 [=>............................] - ETA: 1s - loss: 0.3950 3136/31047 [==>...........................] - ETA: 1s - loss: 0.3982 4160/31047 [===>..........................] - ETA: 1s - loss: 0.4072 5216/31047 [====>.........................] - ETA: 1s - loss: 0.4072 6368/31047 [=====>........................] - ETA: 1s - loss: 0.4031 7648/31047 [======>.......................] - ETA: 1s - loss: 0.4023 8832/31047 [=======>......................] - ETA: 1s - loss: 0.399610016/31047 [========>.....................] - ETA: 0s - loss: 0.399911200/31047 [=========>....................] - ETA: 0s - loss: 0.398112384/31047 [==========>...................] - ETA: 0s - loss: 0.395213568/31047 [============>.................] - ETA: 0s - loss: 0.396114784/31047 [=============>................] - ETA: 0s - loss: 0.397015904/31047 [==============>...............] - ETA: 0s - loss: 0.396817088/31047 [===============>..............] - ETA: 0s - loss: 0.395018240/31047 [================>.............] - ETA: 0s - loss: 0.395219520/31047 [=================>............] - ETA: 0s - loss: 0.395420864/31047 [===================>..........] - ETA: 0s - loss: 0.396122144/31047 [====================>.........] - ETA: 0s - loss: 0.395823328/31047 [=====================>........] - ETA: 0s - loss: 0.396324544/31047 [======================>.......] - ETA: 0s - loss: 0.396725696/31047 [=======================>......] - ETA: 0s - loss: 0.396226912/31047 [=========================>....] - ETA: 0s - loss: 0.396828096/31047 [==========================>...] - ETA: 0s - loss: 0.396029184/31047 [===========================>..] - ETA: 0s - loss: 0.397630400/31047 [============================>.] - ETA: 0s - loss: 0.397431047/31047 [==============================] - 1s 46us/step - loss: 0.3969 - val_loss: 0.3765
Epoch 6/30
   32/31047 [..............................] - ETA: 3s - loss: 0.3653 1088/31047 [>.............................] - ETA: 1s - loss: 0.3951 2176/31047 [=>............................] - ETA: 1s - loss: 0.3891 3296/31047 [==>...........................] - ETA: 1s - loss: 0.3935 4384/31047 [===>..........................] - ETA: 1s - loss: 0.3983 5600/31047 [====>.........................] - ETA: 1s - loss: 0.3915 6848/31047 [=====>........................] - ETA: 1s - loss: 0.3881 8096/31047 [======>.......................] - ETA: 1s - loss: 0.3928 9280/31047 [=======>......................] - ETA: 0s - loss: 0.391810528/31047 [=========>....................] - ETA: 0s - loss: 0.394911776/31047 [==========>...................] - ETA: 0s - loss: 0.397012992/31047 [===========>..................] - ETA: 0s - loss: 0.395214176/31047 [============>.................] - ETA: 0s - loss: 0.395815424/31047 [=============>................] - ETA: 0s - loss: 0.397216608/31047 [===============>..............] - ETA: 0s - loss: 0.397017568/31047 [===============>..............] - ETA: 0s - loss: 0.398718912/31047 [=================>............] - ETA: 0s - loss: 0.397720256/31047 [==================>...........] - ETA: 0s - loss: 0.395921664/31047 [===================>..........] - ETA: 0s - loss: 0.396023008/31047 [=====================>........] - ETA: 0s - loss: 0.397324416/31047 [======================>.......] - ETA: 0s - loss: 0.397025760/31047 [=======================>......] - ETA: 0s - loss: 0.396527040/31047 [=========================>....] - ETA: 0s - loss: 0.394928288/31047 [==========================>...] - ETA: 0s - loss: 0.394129568/31047 [===========================>..] - ETA: 0s - loss: 0.394130848/31047 [============================>.] - ETA: 0s - loss: 0.394231047/31047 [==============================] - 1s 43us/step - loss: 0.3940 - val_loss: 0.3739
Epoch 7/30
   32/31047 [..............................] - ETA: 2s - loss: 0.2680 1344/31047 [>.............................] - ETA: 1s - loss: 0.3977 2688/31047 [=>............................] - ETA: 1s - loss: 0.3925 4000/31047 [==>...........................] - ETA: 1s - loss: 0.3933 5184/31047 [====>.........................] - ETA: 1s - loss: 0.3976 6464/31047 [=====>........................] - ETA: 0s - loss: 0.3967 7712/31047 [======>.......................] - ETA: 0s - loss: 0.3952 8992/31047 [=======>......................] - ETA: 0s - loss: 0.393310336/31047 [========>.....................] - ETA: 0s - loss: 0.390311584/31047 [==========>...................] - ETA: 0s - loss: 0.391012864/31047 [===========>..................] - ETA: 0s - loss: 0.392714144/31047 [============>.................] - ETA: 0s - loss: 0.393115488/31047 [=============>................] - ETA: 0s - loss: 0.392416768/31047 [===============>..............] - ETA: 0s - loss: 0.395118048/31047 [================>.............] - ETA: 0s - loss: 0.394919296/31047 [=================>............] - ETA: 0s - loss: 0.395220608/31047 [==================>...........] - ETA: 0s - loss: 0.395221824/31047 [====================>.........] - ETA: 0s - loss: 0.394323104/31047 [=====================>........] - ETA: 0s - loss: 0.394824352/31047 [======================>.......] - ETA: 0s - loss: 0.394325632/31047 [=======================>......] - ETA: 0s - loss: 0.394226880/31047 [========================>.....] - ETA: 0s - loss: 0.393428160/31047 [==========================>...] - ETA: 0s - loss: 0.393129376/31047 [===========================>..] - ETA: 0s - loss: 0.391830656/31047 [============================>.] - ETA: 0s - loss: 0.391931047/31047 [==============================] - 1s 42us/step - loss: 0.3918 - val_loss: 0.3723
Epoch 8/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3947 1312/31047 [>.............................] - ETA: 1s - loss: 0.3797 2656/31047 [=>............................] - ETA: 1s - loss: 0.3821 3936/31047 [==>...........................] - ETA: 1s - loss: 0.3914 5184/31047 [====>.........................] - ETA: 1s - loss: 0.3939 6464/31047 [=====>........................] - ETA: 0s - loss: 0.3992 7776/31047 [======>.......................] - ETA: 0s - loss: 0.4005 9152/31047 [=======>......................] - ETA: 0s - loss: 0.397610432/31047 [=========>....................] - ETA: 0s - loss: 0.395011808/31047 [==========>...................] - ETA: 0s - loss: 0.393413216/31047 [===========>..................] - ETA: 0s - loss: 0.390914496/31047 [=============>................] - ETA: 0s - loss: 0.392915808/31047 [==============>...............] - ETA: 0s - loss: 0.392017056/31047 [===============>..............] - ETA: 0s - loss: 0.391218336/31047 [================>.............] - ETA: 0s - loss: 0.392019616/31047 [=================>............] - ETA: 0s - loss: 0.392520960/31047 [===================>..........] - ETA: 0s - loss: 0.392122304/31047 [====================>.........] - ETA: 0s - loss: 0.391823648/31047 [=====================>........] - ETA: 0s - loss: 0.391924992/31047 [=======================>......] - ETA: 0s - loss: 0.392426272/31047 [========================>.....] - ETA: 0s - loss: 0.390527648/31047 [=========================>....] - ETA: 0s - loss: 0.391829024/31047 [===========================>..] - ETA: 0s - loss: 0.391830336/31047 [============================>.] - ETA: 0s - loss: 0.391431047/31047 [==============================] - 1s 41us/step - loss: 0.3903 - val_loss: 0.3709
Epoch 9/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3042 1056/31047 [>.............................] - ETA: 1s - loss: 0.3910 2080/31047 [=>............................] - ETA: 1s - loss: 0.4129 3104/31047 [=>............................] - ETA: 1s - loss: 0.4043 4160/31047 [===>..........................] - ETA: 1s - loss: 0.3966 5120/31047 [===>..........................] - ETA: 1s - loss: 0.3966 6144/31047 [====>.........................] - ETA: 1s - loss: 0.3990 7136/31047 [=====>........................] - ETA: 1s - loss: 0.3976 8256/31047 [======>.......................] - ETA: 1s - loss: 0.3960 9280/31047 [=======>......................] - ETA: 1s - loss: 0.397710336/31047 [========>.....................] - ETA: 1s - loss: 0.393411520/31047 [==========>...................] - ETA: 0s - loss: 0.390312544/31047 [===========>..................] - ETA: 0s - loss: 0.389113664/31047 [============>.................] - ETA: 0s - loss: 0.390714752/31047 [=============>................] - ETA: 0s - loss: 0.391916128/31047 [==============>...............] - ETA: 0s - loss: 0.392617536/31047 [===============>..............] - ETA: 0s - loss: 0.393018848/31047 [=================>............] - ETA: 0s - loss: 0.392620064/31047 [==================>...........] - ETA: 0s - loss: 0.393621152/31047 [===================>..........] - ETA: 0s - loss: 0.392422208/31047 [====================>.........] - ETA: 0s - loss: 0.392123264/31047 [=====================>........] - ETA: 0s - loss: 0.390224384/31047 [======================>.......] - ETA: 0s - loss: 0.390125632/31047 [=======================>......] - ETA: 0s - loss: 0.388626912/31047 [=========================>....] - ETA: 0s - loss: 0.388628256/31047 [==========================>...] - ETA: 0s - loss: 0.388529600/31047 [===========================>..] - ETA: 0s - loss: 0.389230752/31047 [============================>.] - ETA: 0s - loss: 0.389431047/31047 [==============================] - 1s 47us/step - loss: 0.3891 - val_loss: 0.3699
Epoch 10/30
   32/31047 [..............................] - ETA: 3s - loss: 0.2031 1184/31047 [>.............................] - ETA: 1s - loss: 0.3481 2336/31047 [=>............................] - ETA: 1s - loss: 0.3560 3520/31047 [==>...........................] - ETA: 1s - loss: 0.3700 4672/31047 [===>..........................] - ETA: 1s - loss: 0.3697 5824/31047 [====>.........................] - ETA: 1s - loss: 0.3730 7008/31047 [=====>........................] - ETA: 1s - loss: 0.3834 8192/31047 [======>.......................] - ETA: 1s - loss: 0.3807 9408/31047 [========>.....................] - ETA: 0s - loss: 0.385910560/31047 [=========>....................] - ETA: 0s - loss: 0.388211840/31047 [==========>...................] - ETA: 0s - loss: 0.389213184/31047 [===========>..................] - ETA: 0s - loss: 0.387714528/31047 [=============>................] - ETA: 0s - loss: 0.385615872/31047 [==============>...............] - ETA: 0s - loss: 0.385617248/31047 [===============>..............] - ETA: 0s - loss: 0.387518528/31047 [================>.............] - ETA: 0s - loss: 0.385819904/31047 [==================>...........] - ETA: 0s - loss: 0.385521216/31047 [===================>..........] - ETA: 0s - loss: 0.384622560/31047 [====================>.........] - ETA: 0s - loss: 0.384423872/31047 [======================>.......] - ETA: 0s - loss: 0.384825120/31047 [=======================>......] - ETA: 0s - loss: 0.385126304/31047 [========================>.....] - ETA: 0s - loss: 0.385227520/31047 [=========================>....] - ETA: 0s - loss: 0.385828384/31047 [==========================>...] - ETA: 0s - loss: 0.387529568/31047 [===========================>..] - ETA: 0s - loss: 0.387830816/31047 [============================>.] - ETA: 0s - loss: 0.387831047/31047 [==============================] - 1s 43us/step - loss: 0.3880 - val_loss: 0.3694
Epoch 11/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4573 1088/31047 [>.............................] - ETA: 1s - loss: 0.4186 2176/31047 [=>............................] - ETA: 1s - loss: 0.4067 3328/31047 [==>...........................] - ETA: 1s - loss: 0.4103 4576/31047 [===>..........................] - ETA: 1s - loss: 0.4005 5760/31047 [====>.........................] - ETA: 1s - loss: 0.3950 6976/31047 [=====>........................] - ETA: 1s - loss: 0.3889 8320/31047 [=======>......................] - ETA: 0s - loss: 0.3890 9632/31047 [========>.....................] - ETA: 0s - loss: 0.389910976/31047 [=========>....................] - ETA: 0s - loss: 0.386112288/31047 [==========>...................] - ETA: 0s - loss: 0.383613600/31047 [============>.................] - ETA: 0s - loss: 0.383714944/31047 [=============>................] - ETA: 0s - loss: 0.384216224/31047 [==============>...............] - ETA: 0s - loss: 0.385617408/31047 [===============>..............] - ETA: 0s - loss: 0.386418528/31047 [================>.............] - ETA: 0s - loss: 0.386319616/31047 [=================>............] - ETA: 0s - loss: 0.386320768/31047 [===================>..........] - ETA: 0s - loss: 0.385222016/31047 [====================>.........] - ETA: 0s - loss: 0.385823136/31047 [=====================>........] - ETA: 0s - loss: 0.386524288/31047 [======================>.......] - ETA: 0s - loss: 0.386025472/31047 [=======================>......] - ETA: 0s - loss: 0.385126816/31047 [========================>.....] - ETA: 0s - loss: 0.386728128/31047 [==========================>...] - ETA: 0s - loss: 0.386129536/31047 [===========================>..] - ETA: 0s - loss: 0.385730816/31047 [============================>.] - ETA: 0s - loss: 0.387031047/31047 [==============================] - 1s 43us/step - loss: 0.3872 - val_loss: 0.3688
Epoch 12/30
   32/31047 [..............................] - ETA: 2s - loss: 0.6255 1152/31047 [>.............................] - ETA: 1s - loss: 0.3877 2336/31047 [=>............................] - ETA: 1s - loss: 0.3821 3584/31047 [==>...........................] - ETA: 1s - loss: 0.3840 4864/31047 [===>..........................] - ETA: 1s - loss: 0.3843 6080/31047 [====>.........................] - ETA: 1s - loss: 0.3855 7328/31047 [======>.......................] - ETA: 0s - loss: 0.3890 8576/31047 [=======>......................] - ETA: 0s - loss: 0.3903 9792/31047 [========>.....................] - ETA: 0s - loss: 0.391310272/31047 [========>.....................] - ETA: 1s - loss: 0.390511392/31047 [==========>...................] - ETA: 0s - loss: 0.390412640/31047 [===========>..................] - ETA: 0s - loss: 0.388013888/31047 [============>.................] - ETA: 0s - loss: 0.389115200/31047 [=============>................] - ETA: 0s - loss: 0.391016512/31047 [==============>...............] - ETA: 0s - loss: 0.390117888/31047 [================>.............] - ETA: 0s - loss: 0.390819264/31047 [=================>............] - ETA: 0s - loss: 0.389420672/31047 [==================>...........] - ETA: 0s - loss: 0.389422016/31047 [====================>.........] - ETA: 0s - loss: 0.387923360/31047 [=====================>........] - ETA: 0s - loss: 0.388224512/31047 [======================>.......] - ETA: 0s - loss: 0.387825760/31047 [=======================>......] - ETA: 0s - loss: 0.388026976/31047 [=========================>....] - ETA: 0s - loss: 0.386828192/31047 [==========================>...] - ETA: 0s - loss: 0.386629472/31047 [===========================>..] - ETA: 0s - loss: 0.386630784/31047 [============================>.] - ETA: 0s - loss: 0.386631047/31047 [==============================] - 1s 45us/step - loss: 0.3866 - val_loss: 0.3683
Epoch 13/30
   32/31047 [..............................] - ETA: 2s - loss: 0.5746 1376/31047 [>.............................] - ETA: 1s - loss: 0.3975 2592/31047 [=>............................] - ETA: 1s - loss: 0.3785 3840/31047 [==>...........................] - ETA: 1s - loss: 0.3790 5056/31047 [===>..........................] - ETA: 1s - loss: 0.3779 6304/31047 [=====>........................] - ETA: 1s - loss: 0.3790 7552/31047 [======>.......................] - ETA: 0s - loss: 0.3799 8768/31047 [=======>......................] - ETA: 0s - loss: 0.382910144/31047 [========>.....................] - ETA: 0s - loss: 0.387611424/31047 [==========>...................] - ETA: 0s - loss: 0.389412736/31047 [===========>..................] - ETA: 0s - loss: 0.388714112/31047 [============>.................] - ETA: 0s - loss: 0.387715456/31047 [=============>................] - ETA: 0s - loss: 0.386916832/31047 [===============>..............] - ETA: 0s - loss: 0.386518208/31047 [================>.............] - ETA: 0s - loss: 0.388119552/31047 [=================>............] - ETA: 0s - loss: 0.388120928/31047 [===================>..........] - ETA: 0s - loss: 0.387322272/31047 [====================>.........] - ETA: 0s - loss: 0.386023584/31047 [=====================>........] - ETA: 0s - loss: 0.385424576/31047 [======================>.......] - ETA: 0s - loss: 0.385425696/31047 [=======================>......] - ETA: 0s - loss: 0.385226848/31047 [========================>.....] - ETA: 0s - loss: 0.385028096/31047 [==========================>...] - ETA: 0s - loss: 0.385129408/31047 [===========================>..] - ETA: 0s - loss: 0.385830784/31047 [============================>.] - ETA: 0s - loss: 0.385931047/31047 [==============================] - 1s 41us/step - loss: 0.3860 - val_loss: 0.3678
Epoch 14/30
   32/31047 [..............................] - ETA: 2s - loss: 0.2455 1376/31047 [>.............................] - ETA: 1s - loss: 0.4273 2784/31047 [=>............................] - ETA: 1s - loss: 0.4040 4160/31047 [===>..........................] - ETA: 0s - loss: 0.3894 5536/31047 [====>.........................] - ETA: 0s - loss: 0.3857 6912/31047 [=====>........................] - ETA: 0s - loss: 0.3886 8256/31047 [======>.......................] - ETA: 0s - loss: 0.3869 9632/31047 [========>.....................] - ETA: 0s - loss: 0.386710880/31047 [=========>....................] - ETA: 0s - loss: 0.383812224/31047 [==========>...................] - ETA: 0s - loss: 0.380913312/31047 [===========>..................] - ETA: 0s - loss: 0.379814176/31047 [============>.................] - ETA: 0s - loss: 0.380915424/31047 [=============>................] - ETA: 0s - loss: 0.382415904/31047 [==============>...............] - ETA: 0s - loss: 0.383316416/31047 [==============>...............] - ETA: 0s - loss: 0.382217088/31047 [===============>..............] - ETA: 0s - loss: 0.382618016/31047 [================>.............] - ETA: 0s - loss: 0.383219200/31047 [=================>............] - ETA: 0s - loss: 0.384120032/31047 [==================>...........] - ETA: 0s - loss: 0.384921088/31047 [===================>..........] - ETA: 0s - loss: 0.384121888/31047 [====================>.........] - ETA: 0s - loss: 0.383822944/31047 [=====================>........] - ETA: 0s - loss: 0.382524128/31047 [======================>.......] - ETA: 0s - loss: 0.381625376/31047 [=======================>......] - ETA: 0s - loss: 0.383026560/31047 [========================>.....] - ETA: 0s - loss: 0.383327776/31047 [=========================>....] - ETA: 0s - loss: 0.383328992/31047 [===========================>..] - ETA: 0s - loss: 0.383930208/31047 [============================>.] - ETA: 0s - loss: 0.384831047/31047 [==============================] - 1s 48us/step - loss: 0.3855 - val_loss: 0.3683
Epoch 15/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3578 1248/31047 [>.............................] - ETA: 1s - loss: 0.3579 2432/31047 [=>............................] - ETA: 1s - loss: 0.3743 3616/31047 [==>...........................] - ETA: 1s - loss: 0.3715 4736/31047 [===>..........................] - ETA: 1s - loss: 0.3768 5920/31047 [====>.........................] - ETA: 1s - loss: 0.3730 7072/31047 [=====>........................] - ETA: 1s - loss: 0.3735 7968/31047 [======>.......................] - ETA: 1s - loss: 0.3764 9216/31047 [=======>......................] - ETA: 0s - loss: 0.375910464/31047 [=========>....................] - ETA: 0s - loss: 0.378411744/31047 [==========>...................] - ETA: 0s - loss: 0.377113024/31047 [===========>..................] - ETA: 0s - loss: 0.379714304/31047 [============>.................] - ETA: 0s - loss: 0.380115296/31047 [=============>................] - ETA: 0s - loss: 0.380816352/31047 [==============>...............] - ETA: 0s - loss: 0.382217376/31047 [===============>..............] - ETA: 0s - loss: 0.384318528/31047 [================>.............] - ETA: 0s - loss: 0.384119648/31047 [=================>............] - ETA: 0s - loss: 0.381820864/31047 [===================>..........] - ETA: 0s - loss: 0.383022016/31047 [====================>.........] - ETA: 0s - loss: 0.383323264/31047 [=====================>........] - ETA: 0s - loss: 0.385024480/31047 [======================>.......] - ETA: 0s - loss: 0.383425760/31047 [=======================>......] - ETA: 0s - loss: 0.382026976/31047 [=========================>....] - ETA: 0s - loss: 0.381928192/31047 [==========================>...] - ETA: 0s - loss: 0.382929344/31047 [===========================>..] - ETA: 0s - loss: 0.382830464/31047 [============================>.] - ETA: 0s - loss: 0.384531047/31047 [==============================] - 1s 46us/step - loss: 0.3850 - val_loss: 0.3678
Epoch 16/30
   32/31047 [..............................] - ETA: 2s - loss: 0.2596  864/31047 [..............................] - ETA: 1s - loss: 0.4167 1984/31047 [>.............................] - ETA: 1s - loss: 0.4051 3168/31047 [==>...........................] - ETA: 1s - loss: 0.3975 4384/31047 [===>..........................] - ETA: 1s - loss: 0.3946 5216/31047 [====>.........................] - ETA: 1s - loss: 0.3940 6144/31047 [====>.........................] - ETA: 1s - loss: 0.3940 7392/31047 [======>.......................] - ETA: 1s - loss: 0.3916 8672/31047 [=======>......................] - ETA: 1s - loss: 0.3889 9824/31047 [========>.....................] - ETA: 0s - loss: 0.390010720/31047 [=========>....................] - ETA: 0s - loss: 0.388911840/31047 [==========>...................] - ETA: 0s - loss: 0.386312768/31047 [===========>..................] - ETA: 0s - loss: 0.384213888/31047 [============>.................] - ETA: 0s - loss: 0.385715264/31047 [=============>................] - ETA: 0s - loss: 0.386616576/31047 [===============>..............] - ETA: 0s - loss: 0.388117824/31047 [================>.............] - ETA: 0s - loss: 0.387619168/31047 [=================>............] - ETA: 0s - loss: 0.387920512/31047 [==================>...........] - ETA: 0s - loss: 0.387021568/31047 [===================>..........] - ETA: 0s - loss: 0.385622656/31047 [====================>.........] - ETA: 0s - loss: 0.386223776/31047 [=====================>........] - ETA: 0s - loss: 0.386225088/31047 [=======================>......] - ETA: 0s - loss: 0.385326272/31047 [========================>.....] - ETA: 0s - loss: 0.385627552/31047 [=========================>....] - ETA: 0s - loss: 0.385528864/31047 [==========================>...] - ETA: 0s - loss: 0.385130176/31047 [============================>.] - ETA: 0s - loss: 0.385231047/31047 [==============================] - 1s 46us/step - loss: 0.3847 - val_loss: 0.3670
Epoch 17/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3386 1120/31047 [>.............................] - ETA: 1s - loss: 0.3683 2272/31047 [=>............................] - ETA: 1s - loss: 0.3881 3392/31047 [==>...........................] - ETA: 1s - loss: 0.3757 4576/31047 [===>..........................] - ETA: 1s - loss: 0.3796 5728/31047 [====>.........................] - ETA: 1s - loss: 0.3817 6880/31047 [=====>........................] - ETA: 1s - loss: 0.3829 8192/31047 [======>.......................] - ETA: 0s - loss: 0.3805 9376/31047 [========>.....................] - ETA: 0s - loss: 0.380910720/31047 [=========>....................] - ETA: 0s - loss: 0.381212064/31047 [==========>...................] - ETA: 0s - loss: 0.380813440/31047 [===========>..................] - ETA: 0s - loss: 0.381014784/31047 [=============>................] - ETA: 0s - loss: 0.384016128/31047 [==============>...............] - ETA: 0s - loss: 0.385817280/31047 [===============>..............] - ETA: 0s - loss: 0.385418464/31047 [================>.............] - ETA: 0s - loss: 0.386719552/31047 [=================>............] - ETA: 0s - loss: 0.386720704/31047 [===================>..........] - ETA: 0s - loss: 0.387721856/31047 [====================>.........] - ETA: 0s - loss: 0.388223040/31047 [=====================>........] - ETA: 0s - loss: 0.389624160/31047 [======================>.......] - ETA: 0s - loss: 0.389525344/31047 [=======================>......] - ETA: 0s - loss: 0.387526528/31047 [========================>.....] - ETA: 0s - loss: 0.387327712/31047 [=========================>....] - ETA: 0s - loss: 0.387228896/31047 [==========================>...] - ETA: 0s - loss: 0.386130112/31047 [============================>.] - ETA: 0s - loss: 0.385331047/31047 [==============================] - 1s 45us/step - loss: 0.3843 - val_loss: 0.3670
Epoch 18/30
   32/31047 [..............................] - ETA: 3s - loss: 0.1923 1312/31047 [>.............................] - ETA: 1s - loss: 0.4007 2592/31047 [=>............................] - ETA: 1s - loss: 0.3990 3936/31047 [==>...........................] - ETA: 1s - loss: 0.3975 5024/31047 [===>..........................] - ETA: 1s - loss: 0.4026 6368/31047 [=====>........................] - ETA: 1s - loss: 0.3971 7680/31047 [======>.......................] - ETA: 0s - loss: 0.3945 8800/31047 [=======>......................] - ETA: 0s - loss: 0.3911 9952/31047 [========>.....................] - ETA: 0s - loss: 0.391611072/31047 [=========>....................] - ETA: 0s - loss: 0.389312320/31047 [==========>...................] - ETA: 0s - loss: 0.389313632/31047 [============>.................] - ETA: 0s - loss: 0.386714912/31047 [=============>................] - ETA: 0s - loss: 0.386216256/31047 [==============>...............] - ETA: 0s - loss: 0.386017600/31047 [================>.............] - ETA: 0s - loss: 0.386518944/31047 [=================>............] - ETA: 0s - loss: 0.386820352/31047 [==================>...........] - ETA: 0s - loss: 0.385621664/31047 [===================>..........] - ETA: 0s - loss: 0.385123008/31047 [=====================>........] - ETA: 0s - loss: 0.384624192/31047 [======================>.......] - ETA: 0s - loss: 0.384525280/31047 [=======================>......] - ETA: 0s - loss: 0.385026240/31047 [========================>.....] - ETA: 0s - loss: 0.384326976/31047 [=========================>....] - ETA: 0s - loss: 0.384127616/31047 [=========================>....] - ETA: 0s - loss: 0.383928256/31047 [==========================>...] - ETA: 0s - loss: 0.384528672/31047 [==========================>...] - ETA: 0s - loss: 0.384929440/31047 [===========================>..] - ETA: 0s - loss: 0.384730624/31047 [============================>.] - ETA: 0s - loss: 0.384531047/31047 [==============================] - 1s 48us/step - loss: 0.3840 - val_loss: 0.3662
Epoch 19/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4787  896/31047 [..............................] - ETA: 1s - loss: 0.3625 2080/31047 [=>............................] - ETA: 1s - loss: 0.3798 3168/31047 [==>...........................] - ETA: 1s - loss: 0.3796 4096/31047 [==>...........................] - ETA: 1s - loss: 0.3786 4992/31047 [===>..........................] - ETA: 1s - loss: 0.3755 6144/31047 [====>.........................] - ETA: 1s - loss: 0.3752 7328/31047 [======>.......................] - ETA: 1s - loss: 0.3734 8448/31047 [=======>......................] - ETA: 1s - loss: 0.3717 9696/31047 [========>.....................] - ETA: 1s - loss: 0.371510912/31047 [=========>....................] - ETA: 0s - loss: 0.374212128/31047 [==========>...................] - ETA: 0s - loss: 0.375413344/31047 [===========>..................] - ETA: 0s - loss: 0.374214592/31047 [=============>................] - ETA: 0s - loss: 0.375415648/31047 [==============>...............] - ETA: 0s - loss: 0.378816864/31047 [===============>..............] - ETA: 0s - loss: 0.380417824/31047 [================>.............] - ETA: 0s - loss: 0.381118912/31047 [=================>............] - ETA: 0s - loss: 0.380519968/31047 [==================>...........] - ETA: 0s - loss: 0.380420896/31047 [===================>..........] - ETA: 0s - loss: 0.380422048/31047 [====================>.........] - ETA: 0s - loss: 0.380723072/31047 [=====================>........] - ETA: 0s - loss: 0.382124256/31047 [======================>.......] - ETA: 0s - loss: 0.382225376/31047 [=======================>......] - ETA: 0s - loss: 0.384526592/31047 [========================>.....] - ETA: 0s - loss: 0.384527552/31047 [=========================>....] - ETA: 0s - loss: 0.384328768/31047 [==========================>...] - ETA: 0s - loss: 0.384629792/31047 [===========================>..] - ETA: 0s - loss: 0.383630752/31047 [============================>.] - ETA: 0s - loss: 0.383731047/31047 [==============================] - 2s 48us/step - loss: 0.3837 - val_loss: 0.3662
Epoch 20/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3985  896/31047 [..............................] - ETA: 1s - loss: 0.3828 2272/31047 [=>............................] - ETA: 1s - loss: 0.3869 3584/31047 [==>...........................] - ETA: 1s - loss: 0.3947 4864/31047 [===>..........................] - ETA: 1s - loss: 0.3857 6080/31047 [====>.........................] - ETA: 1s - loss: 0.3877 7232/31047 [=====>........................] - ETA: 1s - loss: 0.3848 8448/31047 [=======>......................] - ETA: 0s - loss: 0.3828 9568/31047 [========>.....................] - ETA: 0s - loss: 0.380910688/31047 [=========>....................] - ETA: 0s - loss: 0.385411904/31047 [==========>...................] - ETA: 0s - loss: 0.386113088/31047 [===========>..................] - ETA: 0s - loss: 0.387513728/31047 [============>.................] - ETA: 0s - loss: 0.385514272/31047 [============>.................] - ETA: 0s - loss: 0.384414752/31047 [=============>................] - ETA: 0s - loss: 0.384315712/31047 [==============>...............] - ETA: 0s - loss: 0.385016832/31047 [===============>..............] - ETA: 0s - loss: 0.383917568/31047 [===============>..............] - ETA: 0s - loss: 0.383918560/31047 [================>.............] - ETA: 0s - loss: 0.381519744/31047 [==================>...........] - ETA: 0s - loss: 0.381521024/31047 [===================>..........] - ETA: 0s - loss: 0.380622272/31047 [====================>.........] - ETA: 0s - loss: 0.381523552/31047 [=====================>........] - ETA: 0s - loss: 0.381424832/31047 [======================>.......] - ETA: 0s - loss: 0.381626112/31047 [========================>.....] - ETA: 0s - loss: 0.381327360/31047 [=========================>....] - ETA: 0s - loss: 0.382028672/31047 [==========================>...] - ETA: 0s - loss: 0.382429952/31047 [===========================>..] - ETA: 0s - loss: 0.383231047/31047 [==============================] - 1s 47us/step - loss: 0.3834 - val_loss: 0.3661
Epoch 21/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3544 1024/31047 [..............................] - ETA: 1s - loss: 0.3892 2112/31047 [=>............................] - ETA: 1s - loss: 0.3802 3360/31047 [==>...........................] - ETA: 1s - loss: 0.3763 4672/31047 [===>..........................] - ETA: 1s - loss: 0.3755 5952/31047 [====>.........................] - ETA: 1s - loss: 0.3781 7136/31047 [=====>........................] - ETA: 1s - loss: 0.3750 8288/31047 [=======>......................] - ETA: 0s - loss: 0.3762 9536/31047 [========>.....................] - ETA: 0s - loss: 0.377810816/31047 [=========>....................] - ETA: 0s - loss: 0.376712032/31047 [==========>...................] - ETA: 0s - loss: 0.376213280/31047 [===========>..................] - ETA: 0s - loss: 0.378514528/31047 [=============>................] - ETA: 0s - loss: 0.381315840/31047 [==============>...............] - ETA: 0s - loss: 0.380317152/31047 [===============>..............] - ETA: 0s - loss: 0.380418464/31047 [================>.............] - ETA: 0s - loss: 0.380019840/31047 [==================>...........] - ETA: 0s - loss: 0.381421152/31047 [===================>..........] - ETA: 0s - loss: 0.382622528/31047 [====================>.........] - ETA: 0s - loss: 0.382023872/31047 [======================>.......] - ETA: 0s - loss: 0.384425248/31047 [=======================>......] - ETA: 0s - loss: 0.383526560/31047 [========================>.....] - ETA: 0s - loss: 0.382627904/31047 [=========================>....] - ETA: 0s - loss: 0.383629056/31047 [===========================>..] - ETA: 0s - loss: 0.383930080/31047 [============================>.] - ETA: 0s - loss: 0.383731047/31047 [==============================] - 1s 42us/step - loss: 0.3831 - val_loss: 0.3659
Epoch 22/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4862 1248/31047 [>.............................] - ETA: 1s - loss: 0.3672 2528/31047 [=>............................] - ETA: 1s - loss: 0.3680 3648/31047 [==>...........................] - ETA: 1s - loss: 0.3841 4928/31047 [===>..........................] - ETA: 1s - loss: 0.3917 6176/31047 [====>.........................] - ETA: 1s - loss: 0.3894 7424/31047 [======>.......................] - ETA: 0s - loss: 0.3865 8672/31047 [=======>......................] - ETA: 0s - loss: 0.3832 9952/31047 [========>.....................] - ETA: 0s - loss: 0.385711232/31047 [=========>....................] - ETA: 0s - loss: 0.386912512/31047 [===========>..................] - ETA: 0s - loss: 0.384213760/31047 [============>.................] - ETA: 0s - loss: 0.386414784/31047 [=============>................] - ETA: 0s - loss: 0.385615776/31047 [==============>...............] - ETA: 0s - loss: 0.383416928/31047 [===============>..............] - ETA: 0s - loss: 0.383918208/31047 [================>.............] - ETA: 0s - loss: 0.384519520/31047 [=================>............] - ETA: 0s - loss: 0.385520832/31047 [===================>..........] - ETA: 0s - loss: 0.385622112/31047 [====================>.........] - ETA: 0s - loss: 0.386423424/31047 [=====================>........] - ETA: 0s - loss: 0.384024736/31047 [======================>.......] - ETA: 0s - loss: 0.384326016/31047 [========================>.....] - ETA: 0s - loss: 0.382227392/31047 [=========================>....] - ETA: 0s - loss: 0.382428736/31047 [==========================>...] - ETA: 0s - loss: 0.381930112/31047 [============================>.] - ETA: 0s - loss: 0.382731047/31047 [==============================] - 1s 42us/step - loss: 0.3829 - val_loss: 0.3658
Epoch 23/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3159 1280/31047 [>.............................] - ETA: 1s - loss: 0.3697 2592/31047 [=>............................] - ETA: 1s - loss: 0.3731 3872/31047 [==>...........................] - ETA: 1s - loss: 0.3816 5152/31047 [===>..........................] - ETA: 1s - loss: 0.3810 6400/31047 [=====>........................] - ETA: 0s - loss: 0.3816 7712/31047 [======>.......................] - ETA: 0s - loss: 0.3811 8928/31047 [=======>......................] - ETA: 0s - loss: 0.380610240/31047 [========>.....................] - ETA: 0s - loss: 0.383511488/31047 [==========>...................] - ETA: 0s - loss: 0.384012768/31047 [===========>..................] - ETA: 0s - loss: 0.384714080/31047 [============>.................] - ETA: 0s - loss: 0.384915360/31047 [=============>................] - ETA: 0s - loss: 0.382116672/31047 [===============>..............] - ETA: 0s - loss: 0.381418016/31047 [================>.............] - ETA: 0s - loss: 0.382419328/31047 [=================>............] - ETA: 0s - loss: 0.381720672/31047 [==================>...........] - ETA: 0s - loss: 0.381921984/31047 [====================>.........] - ETA: 0s - loss: 0.381823328/31047 [=====================>........] - ETA: 0s - loss: 0.382324672/31047 [======================>.......] - ETA: 0s - loss: 0.381525952/31047 [========================>.....] - ETA: 0s - loss: 0.382127264/31047 [=========================>....] - ETA: 0s - loss: 0.381928288/31047 [==========================>...] - ETA: 0s - loss: 0.382529536/31047 [===========================>..] - ETA: 0s - loss: 0.382730848/31047 [============================>.] - ETA: 0s - loss: 0.382431047/31047 [==============================] - 1s 42us/step - loss: 0.3828 - val_loss: 0.3656
Epoch 24/30
   32/31047 [..............................] - ETA: 2s - loss: 0.2492  704/31047 [..............................] - ETA: 2s - loss: 0.3807 1728/31047 [>.............................] - ETA: 1s - loss: 0.3742 3104/31047 [=>............................] - ETA: 1s - loss: 0.3813 4480/31047 [===>..........................] - ETA: 1s - loss: 0.3802 5792/31047 [====>.........................] - ETA: 1s - loss: 0.3813 7104/31047 [=====>........................] - ETA: 1s - loss: 0.3755 8416/31047 [=======>......................] - ETA: 0s - loss: 0.3761 9696/31047 [========>.....................] - ETA: 0s - loss: 0.378611008/31047 [=========>....................] - ETA: 0s - loss: 0.379712288/31047 [==========>...................] - ETA: 0s - loss: 0.380113536/31047 [============>.................] - ETA: 0s - loss: 0.380014848/31047 [=============>................] - ETA: 0s - loss: 0.380216128/31047 [==============>...............] - ETA: 0s - loss: 0.379717408/31047 [===============>..............] - ETA: 0s - loss: 0.380818688/31047 [=================>............] - ETA: 0s - loss: 0.379519872/31047 [==================>...........] - ETA: 0s - loss: 0.378820896/31047 [===================>..........] - ETA: 0s - loss: 0.377722080/31047 [====================>.........] - ETA: 0s - loss: 0.379623392/31047 [=====================>........] - ETA: 0s - loss: 0.379724672/31047 [======================>.......] - ETA: 0s - loss: 0.381525888/31047 [========================>.....] - ETA: 0s - loss: 0.381727232/31047 [=========================>....] - ETA: 0s - loss: 0.381428576/31047 [==========================>...] - ETA: 0s - loss: 0.382729952/31047 [===========================>..] - ETA: 0s - loss: 0.381931047/31047 [==============================] - 1s 42us/step - loss: 0.3826 - val_loss: 0.3659
Epoch 25/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4278 1344/31047 [>.............................] - ETA: 1s - loss: 0.3750 2656/31047 [=>............................] - ETA: 1s - loss: 0.3797 3904/31047 [==>...........................] - ETA: 1s - loss: 0.3804 5184/31047 [====>.........................] - ETA: 1s - loss: 0.3833 6496/31047 [=====>........................] - ETA: 0s - loss: 0.3798 7840/31047 [======>.......................] - ETA: 0s - loss: 0.3806 9184/31047 [=======>......................] - ETA: 0s - loss: 0.381110240/31047 [========>.....................] - ETA: 0s - loss: 0.379511488/31047 [==========>...................] - ETA: 0s - loss: 0.376912832/31047 [===========>..................] - ETA: 0s - loss: 0.377814048/31047 [============>.................] - ETA: 0s - loss: 0.378815392/31047 [=============>................] - ETA: 0s - loss: 0.378916704/31047 [===============>..............] - ETA: 0s - loss: 0.377618048/31047 [================>.............] - ETA: 0s - loss: 0.379119264/31047 [=================>............] - ETA: 0s - loss: 0.380120576/31047 [==================>...........] - ETA: 0s - loss: 0.381921888/31047 [====================>.........] - ETA: 0s - loss: 0.380823232/31047 [=====================>........] - ETA: 0s - loss: 0.380624512/31047 [======================>.......] - ETA: 0s - loss: 0.380625888/31047 [========================>.....] - ETA: 0s - loss: 0.381027200/31047 [=========================>....] - ETA: 0s - loss: 0.382128576/31047 [==========================>...] - ETA: 0s - loss: 0.382029920/31047 [===========================>..] - ETA: 0s - loss: 0.381731047/31047 [==============================] - 1s 41us/step - loss: 0.3824 - val_loss: 0.3654
Epoch 26/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3143 1440/31047 [>.............................] - ETA: 1s - loss: 0.4189 2816/31047 [=>............................] - ETA: 1s - loss: 0.3994 4192/31047 [===>..........................] - ETA: 0s - loss: 0.3857 5536/31047 [====>.........................] - ETA: 0s - loss: 0.3900 6944/31047 [=====>........................] - ETA: 0s - loss: 0.3852 8288/31047 [=======>......................] - ETA: 0s - loss: 0.3861 9664/31047 [========>.....................] - ETA: 0s - loss: 0.385311040/31047 [=========>....................] - ETA: 0s - loss: 0.386012448/31047 [===========>..................] - ETA: 0s - loss: 0.381913792/31047 [============>.................] - ETA: 0s - loss: 0.381415168/31047 [=============>................] - ETA: 0s - loss: 0.380416512/31047 [==============>...............] - ETA: 0s - loss: 0.384117888/31047 [================>.............] - ETA: 0s - loss: 0.385319232/31047 [=================>............] - ETA: 0s - loss: 0.384120576/31047 [==================>...........] - ETA: 0s - loss: 0.383621920/31047 [====================>.........] - ETA: 0s - loss: 0.385523296/31047 [=====================>........] - ETA: 0s - loss: 0.384124320/31047 [======================>.......] - ETA: 0s - loss: 0.384625664/31047 [=======================>......] - ETA: 0s - loss: 0.384627008/31047 [=========================>....] - ETA: 0s - loss: 0.385228416/31047 [==========================>...] - ETA: 0s - loss: 0.383829632/31047 [===========================>..] - ETA: 0s - loss: 0.382730880/31047 [============================>.] - ETA: 0s - loss: 0.382731047/31047 [==============================] - 1s 40us/step - loss: 0.3822 - val_loss: 0.3652
Epoch 27/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3404 1376/31047 [>.............................] - ETA: 1s - loss: 0.3815 2624/31047 [=>............................] - ETA: 1s - loss: 0.3766 3936/31047 [==>...........................] - ETA: 1s - loss: 0.3782 5312/31047 [====>.........................] - ETA: 0s - loss: 0.3776 6720/31047 [=====>........................] - ETA: 0s - loss: 0.3775 8096/31047 [======>.......................] - ETA: 0s - loss: 0.3797 9504/31047 [========>.....................] - ETA: 0s - loss: 0.378210880/31047 [=========>....................] - ETA: 0s - loss: 0.376512256/31047 [==========>...................] - ETA: 0s - loss: 0.376613632/31047 [============>.................] - ETA: 0s - loss: 0.375715008/31047 [=============>................] - ETA: 0s - loss: 0.376516384/31047 [==============>...............] - ETA: 0s - loss: 0.376717760/31047 [================>.............] - ETA: 0s - loss: 0.375619136/31047 [=================>............] - ETA: 0s - loss: 0.377220512/31047 [==================>...........] - ETA: 0s - loss: 0.378521888/31047 [====================>.........] - ETA: 0s - loss: 0.378323264/31047 [=====================>........] - ETA: 0s - loss: 0.378224608/31047 [======================>.......] - ETA: 0s - loss: 0.378525984/31047 [========================>.....] - ETA: 0s - loss: 0.379727328/31047 [=========================>....] - ETA: 0s - loss: 0.379828704/31047 [==========================>...] - ETA: 0s - loss: 0.380530048/31047 [============================>.] - ETA: 0s - loss: 0.381231047/31047 [==============================] - 1s 39us/step - loss: 0.3821 - val_loss: 0.3658
Epoch 28/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3218 1408/31047 [>.............................] - ETA: 1s - loss: 0.3790 2816/31047 [=>............................] - ETA: 1s - loss: 0.3902 4192/31047 [===>..........................] - ETA: 0s - loss: 0.4014 5536/31047 [====>.........................] - ETA: 0s - loss: 0.3959 6848/31047 [=====>........................] - ETA: 0s - loss: 0.3911 8256/31047 [======>.......................] - ETA: 0s - loss: 0.3863 9632/31047 [========>.....................] - ETA: 0s - loss: 0.383711040/31047 [=========>....................] - ETA: 0s - loss: 0.384012384/31047 [==========>...................] - ETA: 0s - loss: 0.383113792/31047 [============>.................] - ETA: 0s - loss: 0.382315168/31047 [=============>................] - ETA: 0s - loss: 0.383716576/31047 [===============>..............] - ETA: 0s - loss: 0.381517920/31047 [================>.............] - ETA: 0s - loss: 0.379919328/31047 [=================>............] - ETA: 0s - loss: 0.381520608/31047 [==================>...........] - ETA: 0s - loss: 0.382422016/31047 [====================>.........] - ETA: 0s - loss: 0.383423392/31047 [=====================>........] - ETA: 0s - loss: 0.384624800/31047 [======================>.......] - ETA: 0s - loss: 0.382326144/31047 [========================>.....] - ETA: 0s - loss: 0.381527520/31047 [=========================>....] - ETA: 0s - loss: 0.380828800/31047 [==========================>...] - ETA: 0s - loss: 0.381630112/31047 [============================>.] - ETA: 0s - loss: 0.381331047/31047 [==============================] - 1s 39us/step - loss: 0.3819 - val_loss: 0.3659
Epoch 29/30
   32/31047 [..............................] - ETA: 2s - loss: 0.3374 1408/31047 [>.............................] - ETA: 1s - loss: 0.3480 2816/31047 [=>............................] - ETA: 1s - loss: 0.3712 4192/31047 [===>..........................] - ETA: 0s - loss: 0.3777 5600/31047 [====>.........................] - ETA: 0s - loss: 0.3820 6976/31047 [=====>........................] - ETA: 0s - loss: 0.3782 8352/31047 [=======>......................] - ETA: 0s - loss: 0.3776 9728/31047 [========>.....................] - ETA: 0s - loss: 0.382111136/31047 [=========>....................] - ETA: 0s - loss: 0.381012512/31047 [===========>..................] - ETA: 0s - loss: 0.379413920/31047 [============>.................] - ETA: 0s - loss: 0.380715296/31047 [=============>................] - ETA: 0s - loss: 0.381816704/31047 [===============>..............] - ETA: 0s - loss: 0.382518080/31047 [================>.............] - ETA: 0s - loss: 0.383819168/31047 [=================>............] - ETA: 0s - loss: 0.382920512/31047 [==================>...........] - ETA: 0s - loss: 0.383321920/31047 [====================>.........] - ETA: 0s - loss: 0.382423328/31047 [=====================>........] - ETA: 0s - loss: 0.381624736/31047 [======================>.......] - ETA: 0s - loss: 0.382126112/31047 [========================>.....] - ETA: 0s - loss: 0.382627520/31047 [=========================>....] - ETA: 0s - loss: 0.383028896/31047 [==========================>...] - ETA: 0s - loss: 0.382230304/31047 [============================>.] - ETA: 0s - loss: 0.382131047/31047 [==============================] - 1s 39us/step - loss: 0.3819 - val_loss: 0.3651
Epoch 30/30
   32/31047 [..............................] - ETA: 2s - loss: 0.4170 1440/31047 [>.............................] - ETA: 1s - loss: 0.3616 2816/31047 [=>............................] - ETA: 1s - loss: 0.3606 4224/31047 [===>..........................] - ETA: 0s - loss: 0.3703 5568/31047 [====>.........................] - ETA: 0s - loss: 0.3717 6944/31047 [=====>........................] - ETA: 0s - loss: 0.3721 8288/31047 [=======>......................] - ETA: 0s - loss: 0.3747 9696/31047 [========>.....................] - ETA: 0s - loss: 0.373811072/31047 [=========>....................] - ETA: 0s - loss: 0.375912480/31047 [===========>..................] - ETA: 0s - loss: 0.377313824/31047 [============>.................] - ETA: 0s - loss: 0.377815232/31047 [=============>................] - ETA: 0s - loss: 0.377916576/31047 [===============>..............] - ETA: 0s - loss: 0.376517824/31047 [================>.............] - ETA: 0s - loss: 0.376719168/31047 [=================>............] - ETA: 0s - loss: 0.376720576/31047 [==================>...........] - ETA: 0s - loss: 0.376721888/31047 [====================>.........] - ETA: 0s - loss: 0.378023296/31047 [=====================>........] - ETA: 0s - loss: 0.378024672/31047 [======================>.......] - ETA: 0s - loss: 0.378526080/31047 [========================>.....] - ETA: 0s - loss: 0.380027424/31047 [=========================>....] - ETA: 0s - loss: 0.379928832/31047 [==========================>...] - ETA: 0s - loss: 0.380430176/31047 [============================>.] - ETA: 0s - loss: 0.380931047/31047 [==============================] - 1s 39us/step - loss: 0.3817 - val_loss: 0.3651
> 
> # Organize results -------------------------------------------------------------
> 
> partial_pooled <- 
+   tidy(partial_rec, number = 1) %>%
+   dplyr::select(-terms, -id) %>%
+   setNames(c("where_town", "partial"))
> 
> word_embed <- 
+   tidy(nnet_rec, number = 1) %>%
+   dplyr::select(-terms, -id) %>%
+   setNames(c(paste0("Feature", 1:3), "where_town"))
> 
> all_est <- 
+   partial_pooled %>%
+   full_join(okc_props, by = "where_town") %>%
+   inner_join(word_embed, by = "where_town") %>%
+   dplyr::select(where_town, rate, n, raw, partial, Feature1, Feature2, Feature3)
> 
> odds_rng <- extendrange(c(all_est$raw, all_est$partial), f = 0.01)
> 
> # Figure 5.2 -------------------------------------------------------------------
> # https://bookdown.org/max/FES/categorical-supervised-encoding.html#fig:categorical-log-odds
> 
> 
> odds_1 <- 
+   ggplot(all_est) +
+   aes(x = raw, y = partial, size = log10(n)) + 
+   scale_size(range = c(.1, 6)) +
+   geom_abline(alpha = .4, lty = 2)  +
+   xlim(odds_rng) +
+   ylim(odds_rng) +
+   xlab("Raw Log-Odds") +
+   ylab("Shrunken Log-Odds") + 
+   geom_point(aes(text = gsub("_", " ", where_town)), alpha = .4)
Warning: Ignoring unknown aesthetics: text
> 
> 
> odds_2 <- 
+   ggplot(all_est) +
+   aes(x = .5*(raw + partial), y = raw - partial, size = log10(n)) + 
+   scale_size(range= c(.1, 6)) + 
+   geom_hline(alpha = .4, lty = 2, yintercept = 0) + 
+   xlab("Average Estimate") +
+   ylab("Raw - Shrunken") + 
+   geom_point(aes(text = gsub("_", " ", where_town)), alpha = .4)
Warning: Ignoring unknown aesthetics: text
> 
> odds_1 <- ggplotly(odds_1, tooltip = "text")
> odds_2 <- ggplotly(odds_2, tooltip = "text") 
> 
> # plotly::subplot(odds_1, odds_2, nrows = 1, margin = .05, titleX = TRUE, titleY = TRUE)
> 
> # Figure 5.3 -------------------------------------------------------------------
> # https://bookdown.org/max/FES/categorical-supervised-encoding.html#fig:categorical-word-embed
> 
> embed_plot <- 
+   word_embed %>%
+   full_join(okc_props, by = "where_town") %>%
+   gather(feature, value, -rate, -raw, -n, -where_town) %>%
+   mutate(location = gsub("_", " ", where_town)) %>%
+   ggplot(aes(x = value, y = raw)) + 
+   facet_wrap(~feature, scale = "free_x") + 
+   ylab("Raw Odds-Ratio") + 
+   theme(legend.position = "top") + 
+   xlab("Feature Value") + 
+   scale_size(range = c(.1, 6)) + 
+   geom_point(aes(size = log10(n), text = location), alpha = .4)
Warning: Ignoring unknown aesthetics: text
> 
> # ggplotly(embed_plot, tooltip = "text")
> 
> # ------------------------------------------------------------------------------
> 
> sessionInfo()
R version 3.6.0 (2019-04-26)
Platform: x86_64-apple-darwin15.6.0 (64-bit)
Running under: macOS Mojave 10.14.5

Matrix products: default
BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib
LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

attached base packages:
[1] stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] gridExtra_2.3    plotly_4.9.0     embed_0.0.2      yardstick_0.0.2  tibble_2.0.1     rsample_0.0.4   
 [7] tidyr_0.8.3      recipes_0.1.5    purrr_0.3.1      parsnip_0.0.1    infer_0.4.0      ggplot2_3.1.0   
[13] dplyr_0.8.0.1    dials_0.0.2      scales_1.0.0     broom_0.5.1      tidymodels_0.0.2

loaded via a namespace (and not attached):
  [1] minqa_1.2.4         colorspace_1.4-1    class_7.3-15        ggridges_0.5.1      rsconnect_0.8.13   
  [6] markdown_0.9        base64enc_0.1-3     tidytext_0.2.0      rstudioapi_0.9.0    rstan_2.18.2       
 [11] SnowballC_0.6.0     DT_0.5              fansi_0.4.0         prodlim_2018.04.18  lubridate_1.7.4    
 [16] codetools_0.2-16    splines_3.6.0       knitr_1.23          shinythemes_1.1.2   zeallot_0.1.0      
 [21] bayesplot_1.6.0     jsonlite_1.6        nloptr_1.2.1        pROC_1.15.0         tfruns_1.4         
 [26] shiny_1.2.0         httr_1.4.0          compiler_3.6.0      backports_1.1.3     assertthat_0.2.0   
 [31] Matrix_1.2-17       lazyeval_0.2.1      cli_1.1.0           later_0.8.0         htmltools_0.3.6    
 [36] prettyunits_1.0.2   tools_3.6.0         igraph_1.2.4        gtable_0.2.0        glue_1.3.0         
 [41] reshape2_1.4.3      Rcpp_1.0.0          nlme_3.1-139        crosstalk_1.0.0     timeDate_3043.102  
 [46] gower_0.2.1         xfun_0.7            stringr_1.4.0       ps_1.3.0            lme4_1.1-21        
 [51] mime_0.6            miniUI_0.1.1.1      gtools_3.8.1        tidypredict_0.3.0   MASS_7.3-51.4      
 [56] zoo_1.8-6           ipred_0.9-8         rstanarm_2.18.2     colourpicker_1.0    promises_1.0.1     
 [61] parallel_3.6.0      inline_0.3.15       shinystan_2.5.0     tidyposterior_0.0.2 reticulate_1.11.1  
 [66] keras_2.2.4.1       loo_2.0.0           StanHeaders_2.18.1  rpart_4.1-15        stringi_1.4.3      
 [71] tensorflow_1.13.1   tokenizers_0.2.1    dygraphs_1.1.1.6    boot_1.3-22         pkgbuild_1.0.2     
 [76] lava_1.6.5          rlang_0.3.1         pkgconfig_2.0.2     matrixStats_0.54.0  lattice_0.20-38    
 [81] labeling_0.3        rstantools_1.5.1    htmlwidgets_1.3     processx_3.3.1      tidyselect_0.2.5   
 [86] plyr_1.8.4          magrittr_1.5        R6_2.4.0            generics_0.0.2      whisker_0.3-2      
 [91] pillar_1.3.1        withr_2.1.2         xts_0.11-2          survival_2.44-1.1   nnet_7.3-12        
 [96] janeaustenr_0.1.5   crayon_1.3.4        utf8_1.1.4          grid_3.6.0          data.table_1.12.2  
[101] callr_3.2.0         threejs_0.3.1       digest_0.6.18       xtable_1.8-3        httpuv_1.4.5.1     
[106] stats4_3.6.0        munsell_0.5.0       viridisLite_0.3.0   shinyjs_1.0        
> 
> 
> proc.time()
    user   system  elapsed 
1982.245   11.771  471.850 
